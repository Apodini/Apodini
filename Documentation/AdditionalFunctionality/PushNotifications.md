![document type: vision](https://apodini.github.io/resources/markdown-labels/document_type_vision.svg)

# Push Notifications

The `NotificationCenter` can handle the registration and sending of **push notifications** to Apple Push Notification Service (APNS) and Firebase Cloud Messaging (FCM). APNS can send out push notifications to iOS, macOS and tvOS devices, while FCM handles messaging for iOS, Android, and Web Push.

## Configuration

In order to send push notifications, the Apodini web server needs to be authenticated to at least one push notification service. These services are added to a web server by defining them in the `configuration` computed property.

APNS can be configured using either a `.p8` or a `.pem` certificate. FCM is added using the _service-account.json_ file generated by the Firebase Console.

This example adds APNS using a `.pem` certificate and FCM to the web server.

```swift
var configuration: Configuration {
    APNSConfiguration(.pem(pemPath: "certificate.pem"), identifier: "de.tum.in.ase.Example", environment: .sandbox)
    FCMConfiguration("firebase-adminsdk.json")
}
```

The `NotificationCenter` can also be used to register devices. This is useful to retrieve saved devices and send out push notifications to them. This feature requires a connected **[database](./Database.md)** to Apodini and using the special modifier `addNotifications()` with the `DatabaseConfiguration`. This modifier can either take two arguments or none. When defining it with two arguments we can pass in a fluent migration and the corresponding class conforming to `DeviceProtocol` used as the schema. Leaving the modifier empty will create a new database table called `notification_device` of the default implementation of `DeviceProtocol`.
Additionally, this modifier will create a second database table `topic` which is responsible for storing push notification topics.

The following example configures a MongoDB database and enables the `NotificationCenter` to save devices to the _apodini_db_ database.

```swift
var configuration: Configuration {
    // ...
    DatabaseConfiguration(.defaultMongoDB("mongodb://localhost:27017/apodini_db"))
        .addNotifications()
}
```

## Usage

The `NotificationCenter` can be injected to any `Handler` or `Job` by using the `@Environment` property wrapper.

```swift
struct NewsAlertHandler: Handler {
    @Environment(\.notificationCenter) var notificationCenter: NotificationCener

    // ...
}
```

## Device Registration

Devices can be registered to the `NotificationCenter` by conforming to `DeviceProtocol`. This protocol consists of the following properties:

- **id**: The device id for one app used by the push notification service.
- **user**: The associated user of the device.
- **type**: The push notification service to use.
- **topics**: Used to group devices together. Example: All devices that want to receive news alerts.

A default implementation of this protocol called `Device` can also be used.

```swift
public struct Device: DeviceProtocol {
    public var id: String
    public var type: PushNotificationService
    public var user: User?
    public var topics: [Topic]?
}

public enum PushNotificationService {
    case apns
    case fcm
}
```

The web service needs a specific route and `Handler` to handle push notification registration. The following example shows how to add a `Device` to the currently authenticated `User`.

```swift
struct RegisterHandler: Handler {
    @Request(\.user) var user: User  // The logged in user

    @Parameter var device: Device  // The `Device` instance in a request body

    @Environment(\.notificationCenter) var notificationCenter: NotificationCener

    func handle() -> EventLoopFuture<Void> {
        notificationCenter.register(device, to: user);
    }
}
```

Furthermore, the `NotificationCenter` allows the removal and editing of `Device`s and `Topic`s.

## Sending Push Notifications

`Notification`s are structured as follows:

- **alert**: Displayed message on the device which includes title, subtitle, and body.
- **payload**: Service specific notification settings like sound, badges, etc.
- **data**: Background data conforming to `Encodable`.

Push notifications can also be used to send data. Objects that are sent with push notifications need to conform to `Encodable` and will be converted to JSON format. This object can then be retrieved using the `data` key from the payload of the push notification.

Example of a `Handler` that sends a push notification to an user:

```swift
struct SendNotification: Handler {
    @Request(\.user) var user: User

    @Environment(\.notificationCenter) var notificationCenter: NotificationCener

    func handle() -> EventLoopFuture<Void> {
        let notification = Notification(alert: Alert(title: "Hello There ðŸ‘‹"))
        let data = "I'm also sent!"
        return notificationCenter.send(notification: notification, with: data, to: user)
    }
}
```

The `NotificationCenter` offers the following convenience methods to send push notifications:

- Send to all registered devices
- Send to a subscription
- Send to all devices of a user
- Send to multiple users
- Send to a specific device
- Send to a specific token

## Unsolicited Push Notifications

Events in Apodini can also trigger the sending of push notifications. For examples of this behavior refer to the documentation on **[Jobs](./Jobs.md)**.
